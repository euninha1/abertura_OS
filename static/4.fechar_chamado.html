<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decós Hospital | Encerrar Chamado</title>
  <link rel="stylesheet" href="/static/assets/style.css">
  <link rel="icon" href="imagens/hospital_ico.ico" type="image/x-icon">
</head>

<body>
  <main class="container">
    <div class="logo">
      <img src="/static/imagens/logo.png" alt="Logo Decós">
    </div>

    <h1 class="title">Encerrar Chamado</h1>

    <div class="field">
      <label for="description">Descrição:<br></label>
      <input class="fullwidth" type="text" id="description" size="1000" readonly>
    </div>

    <div class="field">
      <label for="damage">Solução:</label>
      <textarea class="fullwidth" id="damage" rows="7" required></textarea>
    </div>

    <button onclick="realizarEncerramento()" class="button">Encerrar</button>
    <div aria-live="polite" id="feedbackMessage"></div>
  </main>

  <script>
    const storedDescription = localStorage.getItem('description');
    const storedUsername = localStorage.getItem('username'); 

    if (storedDescription) {  
      document.getElementById('description').value = storedDescription;
    }

    if (!storedUsername) { 
      alert('Usuário não logado. Por favor, faça login novamente.')
      window.location.href = '1.homepage.html';
    }

    function realizarEncerramento() {
      const descriptionValue = storedDescription;
      const damageValue = document.getElementById('damage').value.trim();
      const usernameValue = storedUsername;

      if (damageValue === '') {
        alert('Por favor, preencha a solução!');
        return;
      }

      fetch('http://10.222.1.25:5501/verificar_e_atualizar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ds_dano_breve: descriptionValue,
          ds_solucao: damageValue,
          usuario_fechamento: usernameValue
        }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Ocorreu um problema ao encerrar o chamado.');
          }
          return response.json();
        })
        .then((data) => {
          alert(data.message); 
          // Limpa os dados do localStorage após o encerramento
          localStorage.removeItem('description');
          localStorage.removeItem('username');
          window.location.href = '1.homepage.html'; 
        })
        .catch((error) => {
          alert(error.message); 
        });
    }
  </script>

</body>

</html>
