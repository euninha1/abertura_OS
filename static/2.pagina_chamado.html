<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decós Hospital | Abertura de Ordem de Serviço</title>
  <link rel="stylesheet" href="/static/assets/style.css">
  <link rel="icon" href="imagens/hospital_ico.ico" type="image/x-icon">
</head>

<body>
  <main class="container">
    <div class="logo">
      <img src="/static/imagens/logo.png" alt="Logo Decós">
    </div>

    <h1 class="title">Central de Abertura de Chamado</h1>

    <!-- Formulário para enviar os dados -->
    <form class="form" id="orderForm">
      <div class="field">
        <label for="location">Localização:</label>
        <select id="location" name="nr_seq_localizacao" required onchange="filtrarUsuarios()">
          <option value="">Selecione a localização</option>
          <option value="105">Centro Cirúrgico</option>
          <option value="111">Tecnologia da Informação</option>
          <option value="123">Recepção</option>
          <option value="122">Endoscopia</option>
        </select>
      </div>

      <!-- Formulário dos usuários -->
      <div class="field">
        <label for="user">Usuário Solicitante:</label>
        <select id="user" name="username" required>
          <option value="">Selecione o usuário</option>
          <!-- Opções de usuário serão preenchidas dinamicamente pelo JavaScript -->
        </select>
      </div>

      <div class="field">
        <label for="description">Descrição:</label>
        <input class="fullwidth" type="text" id="description" size="1000" required>
      </div>

      <div class="field">
        <label for="damage">Dano:</label>
        <textarea class="fullwidth" id="damage" rows="7" required></textarea>
      </div>

      <button class="button" type="button" onclick="enviarOrdem()">Enviar</button>
    </form>
  </main>

  <!-- Script para enviar os dados para o backend e filtrar os usuários -->
  <script>

    const firstScreenVisited = localStorage.getItem('firstScreenVisited');
    if (!firstScreenVisited) {
      window.location.href = '1.homepage.html';
    }

    const usuariosPorSetor = {
      "105": [
        { value: "65861", text: "Camilla de Assunção Santos Barreto" },
        { value: "186214", text: "Sheisa Alves de Barros Correa" },
        { value: "203787", text:  "Malu Alcantara Oliveira"},
        { value: "112169", text:  "Brenda Caroline Santos da Costa "},
        { value: "200225", text:  "Elayne Oliveira Borges "}
        // Centro Cirúrgico 
      ],
      "111": [
        { value: "112206", text: "Mateus Lima de Oliveira" },
        { value: "46430", text: "Matheus Teles Dantas Barros" },
        { value: "134173", text: "Fernanda Amaral de Souza" },
        { value: "147979", text:  "Phillip José de Oliveira Matos"},
        { value: "13033", text:  "Carlos Wagner Santos de Oliveira"}
        //  TIC
      ],
      "123": [
        { value: "128702", text: "Hilka Freire Evangelista" },
        { value: "133950", text: "Julio Cardoso dos Santos Filho" },
        { value: "181055", text:  "Cintia Araujo dos Santos"},
        { value: "186916", text:  "Nivea Regina Lima Araujo Bastos"},
        { value: "136404", text:  "Rafael Marques da Silva"},
        { value: "130702", text:  "Mychel Douglas do Espírito Santo"}
        //Recepção 
      ],
      "122": [
        { value: "93796", text: "Stefanny Maria campos" },
        { value: "190050", text: "Gilmaria Nunes de Aquino Carvalho"},
        { value: "171303", text: "Daniela Alves Rezende Menezes"},
        { value: "25175", text: "Evellyn Maiara Santos Azevedo"}
        // Endoscopia 
      ]
    };

    function filtrarUsuarios() {
      const location = document.getElementById('location').value;
      const usersSelect = document.getElementById('user');
      usersSelect.innerHTML = '<option value="">Selecione o usuário</option>'; // Limpa as opções

      if (location && usuariosPorSetor[location]) {
        usuariosPorSetor[location].forEach(user => {
          const option = document.createElement('option');
          option.value = user.value;
          option.textContent = `${user.text}`;
          usersSelect.appendChild(option);
        });
      }
    }

    function armazenarDescricao() {
        const descriptionValue = document.getElementById('description').value.trim();
        localStorage.setItem('description', descriptionValue);
        console.log('Descricao armazenada:', descriptionValue);
        return descriptionValue;
      }
    async function enviarOrdem() {
      const form = document.getElementById('orderForm');
      if (!form.checkValidity()) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
      }

      const descricaoCriada = armazenarDescricao();
      console.log('Descrição criada:', descricaoCriada);

      const location = form.elements.nr_seq_localizacao.value;
      const username = form.elements.username.value;
      const ds_dano = form.elements.damage.value;

      const data = {
        nr_seq_localizacao: parseInt(location),
        cd_pessoa_solicitante: parseInt(username),
        ds_dano_breve: descricaoCriada, // Utilize a descrição armazenada
        ds_dano,
      };

      console.log('Data being sent:', data); // Adicionado para depuração

      try {
        const response = await fetch('http://10.222.1.25:5501/criar_ordem_servico/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          window.location.href = "3.mensagem_final.html";
        } else {
          const errorMessage = await response.text();
          console.error('Erro ao enviar os dados:', errorMessage);
          alert('Erro ao enviar os dados: ' + errorMessage);
        }
      } catch (error) {
        console.error('Erro:', error);
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          alert('Não foi possível se conectar ao servidor. Por favor, verifique sua conexão com a internet e o endereço do servidor.');
        } else {
          alert('Erro ao enviar os dados. Por favor, tente novamente mais tarde.');
        }
      }

    }
  </script>

</body>

</html>
